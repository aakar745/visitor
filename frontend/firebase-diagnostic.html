<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase Phone Auth Diagnostic Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
        import { 
            getAuth, 
            RecaptchaVerifier,
            signInWithPhoneNumber
        } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';

        // WORKING WORDPRESS PROJECT - rajcooling-a4dc1
        const firebaseConfig = {
            apiKey: "AIzaSyCvL3yYIv86dFKQd1W5KTW7L5qHK7_uMYs",
            authDomain: "rajcooling-a4dc1.firebaseapp.com",
            projectId: "rajcooling-a4dc1",
            storageBucket: "rajcooling-a4dc1.firebasestorage.app",
            messagingSenderId: "218847565902",
            appId: "1:218847565902:web:80f5a45c9b363224b90b1f",
            measurementId: "G-X6BVK204MC"
        };

        let app, auth, recaptchaVerifier;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logContainer = document.getElementById('logs');
            const logEntry = document.createElement('div');
            
            const colors = {
                success: 'text-green-700 bg-green-50 border-green-300',
                error: 'text-red-700 bg-red-50 border-red-300',
                warning: 'text-yellow-700 bg-yellow-50 border-yellow-300',
                info: 'text-blue-700 bg-blue-50 border-blue-300'
            };

            logEntry.className = `p-3 mb-2 border-l-4 rounded ${colors[type] || colors.info}`;
            logEntry.innerHTML = `
                <span class="text-xs opacity-70">[${timestamp}]</span>
                <span class="ml-2">${message}</span>
            `;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        window.addEventListener('DOMContentLoaded', () => {
            log('üîç Firebase Phone Auth Diagnostic Tool Started', 'info');
            log('', 'info');
            
            try {
                // Initialize Firebase
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                auth.languageCode = 'en';
                
                log('‚úÖ Firebase initialized successfully', 'success');
                log(`   Project ID: ${firebaseConfig.projectId}`, 'info');
                log(`   Auth Domain: ${firebaseConfig.authDomain}`, 'info');
                log('', 'info');
                
                // Check configuration
                log('üìã Configuration Check:', 'info');
                log(`   ‚úì API Key: ${firebaseConfig.apiKey ? 'Present' : '‚ùå Missing'}`, firebaseConfig.apiKey ? 'success' : 'error');
                log(`   ‚úì Auth Domain: ${firebaseConfig.authDomain ? 'Present' : '‚ùå Missing'}`, firebaseConfig.authDomain ? 'success' : 'error');
                log(`   ‚úì Project ID: ${firebaseConfig.projectId ? 'Present' : '‚ùå Missing'}`, firebaseConfig.projectId ? 'success' : 'error');
                log('', 'info');
                
                log('üì± Ready to test Phone Authentication', 'success');
                log('üëâ Click "Initialize reCAPTCHA" to begin', 'info');
                
            } catch (error) {
                log(`‚ùå Firebase initialization failed: ${error.message}`, 'error');
            }
        });

        window.initRecaptcha = async function() {
            try {
                log('üîÑ Initializing reCAPTCHA for Phone Auth...', 'info');
                log('', 'info');
                log('‚ö†Ô∏è IMPORTANT: This uses Firebase Phone Auth reCAPTCHA', 'warning');
                log('   This is DIFFERENT from App Check reCAPTCHA!', 'warning');
                log('', 'info');
                
                // Clear existing
                if (recaptchaVerifier) {
                    recaptchaVerifier.clear();
                    log('üßπ Cleared existing reCAPTCHA', 'info');
                }

                // Create verifier - NO SITE KEY PROVIDED
                // Firebase will use its auto-provisioned reCAPTCHA key
                log('üîí Creating RecaptchaVerifier (no site key - Firebase auto-config)...', 'info');
                
                recaptchaVerifier = new RecaptchaVerifier('recaptcha-container', {
                    size: 'normal',
                    callback: (response) => {
                        log('‚úÖ reCAPTCHA solved successfully!', 'success');
                        log(`   Response token: ${response.substring(0, 30)}...`, 'info');
                        document.getElementById('sendOtpBtn').disabled = false;
                    },
                    'expired-callback': () => {
                        log('‚è∞ reCAPTCHA expired', 'warning');
                        document.getElementById('sendOtpBtn').disabled = true;
                    },
                    'error-callback': (error) => {
                        log(`‚ùå reCAPTCHA error: ${error}`, 'error');
                        document.getElementById('sendOtpBtn').disabled = true;
                    }
                }, auth);

                log('üì¶ RecaptchaVerifier created, rendering widget...', 'info');
                
                // Render
                await recaptchaVerifier.render();
                
                log('', 'info');
                log('‚úÖ SUCCESS! reCAPTCHA widget rendered!', 'success');
                log('', 'info');
                log('üìù What this means:', 'info');
                log('   ‚úì Firebase Phone Auth reCAPTCHA is configured correctly', 'success');
                log('   ‚úì Your Firebase Console settings are correct', 'success');
                log('   ‚úì You can now send SMS OTP', 'success');
                log('', 'info');
                log('üëâ Solve the reCAPTCHA above, then enter a phone number to test', 'info');
                
            } catch (error) {
                log('', 'info');
                log('‚ùå FAILED to initialize reCAPTCHA!', 'error');
                log(`   Error: ${error.message}`, 'error');
                log(`   Code: ${error.code || 'N/A'}`, 'error');
                log('', 'info');
                
                if (error.message?.includes('Invalid site key')) {
                    log('üî¥ ROOT CAUSE: Invalid Site Key', 'error');
                    log('', 'info');
                    log('This means:', 'warning');
                    log('1. Firebase Phone Auth reCAPTCHA is NOT configured in Firebase Console', 'warning');
                    log('2. Or: The configuration hasn\'t propagated yet (wait 5-10 min)', 'warning');
                    log('3. Or: localhost is not in Authorized Domains', 'warning');
                    log('', 'info');
                    log('‚úÖ HOW TO FIX:', 'info');
                    log('', 'info');
                    log('Step 1: Go to Firebase Console', 'info');
                    log('   ‚Üí https://console.firebase.google.com/', 'info');
                    log('', 'info');
                    log('Step 2: Select your project', 'info');
                    log(`   ‚Üí ${firebaseConfig.projectId}`, 'info');
                    log('', 'info');
                    log('Step 3: Navigate to Authentication', 'info');
                    log('   ‚Üí Authentication ‚Üí Settings', 'info');
                    log('', 'info');
                    log('Step 4: Check Phone Number Sign-in', 'info');
                    log('   ‚Üí Make sure Phone sign-in method is ENABLED', 'info');
                    log('   ‚Üí Make sure reCAPTCHA Enforcement is ENABLED', 'info');
                    log('', 'info');
                    log('Step 5: Check Authorized Domains', 'info');
                    log('   ‚Üí Authentication ‚Üí Settings ‚Üí Authorized domains', 'info');
                    log('   ‚Üí Make sure "localhost" is in the list', 'info');
                    log('', 'info');
                    log('Step 6: Wait and Retry', 'info');
                    log('   ‚Üí Wait 5-10 minutes for changes to propagate', 'info');
                    log('   ‚Üí Clear browser cache (Ctrl+Shift+Delete)', 'info');
                    log('   ‚Üí Refresh this page and try again', 'info');
                    log('', 'info');
                    log('üí° IMPORTANT NOTE:', 'warning');
                    log('   The App Check reCAPTCHA key (6LdH2hQsAAAAALtjjlCCZA2Dmrw97WE0FwinST7w)', 'warning');
                    log('   is DIFFERENT from Phone Auth reCAPTCHA!', 'warning');
                    log('   Firebase auto-provisions Phone Auth reCAPTCHA separately.', 'warning');
                } else {
                    log('üí° Check browser console for more details', 'warning');
                }
            }
        }

        window.testPhoneAuth = async function() {
            const phoneInput = document.getElementById('phoneNumber').value;
            
            if (!phoneInput) {
                log('‚ùå Please enter a phone number', 'error');
                return;
            }

            let phoneNumber = phoneInput.trim();
            if (!phoneNumber.startsWith('+')) {
                phoneNumber = '+' + phoneNumber;
            }

            log('', 'info');
            log(`üìû Testing SMS OTP to: ${phoneNumber}`, 'info');
            
            if (!recaptchaVerifier) {
                log('‚ùå reCAPTCHA not initialized', 'error');
                return;
            }

            try {
                document.getElementById('sendOtpBtn').disabled = true;
                
                const confirmationResult = await signInWithPhoneNumber(auth, phoneNumber, recaptchaVerifier);
                
                log('', 'info');
                log('üéâ SUCCESS! SMS OTP sent!', 'success');
                log(`   Verification ID: ${confirmationResult.verificationId}`, 'success');
                log('', 'info');
                log('‚úÖ CONCLUSION:', 'success');
                log('   Your Firebase Phone Auth is working perfectly!', 'success');
                log('   The reCAPTCHA configuration is correct!', 'success');
                log('   You can now use SMS OTP in your app!', 'success');
                
            } catch (error) {
                log('', 'info');
                log('‚ùå Failed to send SMS OTP', 'error');
                log(`   Error: ${error.message}`, 'error');
                log(`   Code: ${error.code}`, 'error');
                
                if (error.code === 'auth/invalid-phone-number') {
                    log('üí° Phone format should be: +[country][number] (e.g., +919876543210)', 'warning');
                } else if (error.code === 'auth/too-many-requests') {
                    log('üí° Too many requests. Wait a few minutes and try again.', 'warning');
                }
            } finally {
                document.getElementById('sendOtpBtn').disabled = false;
            }
        }

        window.clearLogs = function() {
            document.getElementById('logs').innerHTML = '';
            log('üìù Logs cleared', 'info');
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-8 rounded-t-lg shadow-xl">
            <h1 class="text-4xl font-bold mb-2">üîç Firebase Phone Auth Diagnostic</h1>
            <p class="text-purple-100">Check if your reCAPTCHA configuration is correct</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
            <!-- Left: Testing -->
            <div class="space-y-6">
                <!-- Info -->
                <div class="bg-blue-50 border-l-4 border-blue-500 p-6 rounded-lg">
                    <h3 class="font-bold text-blue-900 mb-2">‚ÑπÔ∏è What This Tool Does</h3>
                    <ul class="text-sm text-blue-800 space-y-1 list-disc list-inside">
                        <li>Tests Firebase Phone Auth reCAPTCHA configuration</li>
                        <li>Diagnoses "Invalid site key" errors</li>
                        <li>Provides step-by-step fix instructions</li>
                        <li>Does NOT use App Check (tests Phone Auth only)</li>
                    </ul>
                </div>

                <!-- Step 1 -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold mb-4 text-gray-800">Step 1: Initialize reCAPTCHA</h2>
                    <button 
                        onclick="initRecaptcha()" 
                        class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-6 rounded-lg transition shadow-md"
                    >
                        üîí Initialize Phone Auth reCAPTCHA
                    </button>
                    <div id="recaptcha-container" class="mt-4 flex justify-center"></div>
                </div>

                <!-- Step 2 -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold mb-4 text-gray-800">Step 2: Test SMS OTP</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Phone Number (with country code)
                            </label>
                            <input 
                                type="tel" 
                                id="phoneNumber" 
                                placeholder="+919876543210"
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                            />
                        </div>
                        <button 
                            id="sendOtpBtn"
                            onclick="testPhoneAuth()" 
                            disabled
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition shadow-md disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            üì± Send Test SMS OTP
                        </button>
                    </div>
                </div>

                <!-- Actions -->
                <div class="bg-white rounded-lg shadow-md p-4">
                    <button 
                        onclick="clearLogs()" 
                        class="w-full bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition"
                    >
                        üóëÔ∏è Clear Logs
                    </button>
                </div>
            </div>

            <!-- Right: Logs -->
            <div class="space-y-6">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-bold mb-4 text-gray-800">üìù Diagnostic Logs</h2>
                    <div 
                        id="logs" 
                        class="h-[700px] overflow-y-auto bg-gray-50 rounded-lg p-4 text-sm"
                    ></div>
                </div>
            </div>
        </div>

        <!-- Important Notes -->
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-6 mt-6 rounded-lg">
            <h3 class="font-bold text-yellow-800 mb-2">‚ö†Ô∏è Key Points:</h3>
            <ul class="text-sm text-yellow-700 space-y-1 list-disc list-inside">
                <li><strong>App Check reCAPTCHA ‚â† Phone Auth reCAPTCHA</strong> - They are completely separate!</li>
                <li>App Check key: <code class="bg-yellow-100 px-1">6LdH2hQsAAAAALtjjlCCZA2Dmrw97WE0FwinST7w</code> (for API protection)</li>
                <li>Phone Auth reCAPTCHA: Auto-provisioned by Firebase (no key needed in code)</li>
                <li>If you see "Invalid site key", Phone Auth reCAPTCHA is not configured in Firebase Console</li>
                <li>Make sure <code class="bg-yellow-100 px-1">localhost</code> is in Authorized Domains</li>
            </ul>
        </div>
    </div>
</body>
</html>

